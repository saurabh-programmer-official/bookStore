package com.fabellus.placeorder;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.client.RestTemplate;

import com.fabellus.booksearch.BookInventory;

@Service
@Transactional
public class PlaceOrderServiceImpl implements PlaceOrderService{

	@Autowired
	OrderDAO orderDAO;
	@Autowired
	OrderItemDAO orderItemDAO;
	@Autowired
	BookInventoryDAO bookInventoryDAO;
	
	
	public List<Order> getOrdersByUserId(String userId) {
	// TODO Auto-generated method stub
	List<Order> orderList = orderDAO.findOrdersByUserId(userId);
		return orderList;

	}
	
	
	public OrderInfo placeOrder(OrderInfo orderInfo) {
		// TODO Auto-generated method stub
		//Save the order
		//Order info is coming from front end and order is transient object for now
		Order myorder = orderInfo.getOrder(); //Transient Object, Non Persistent Object without any primary key

//		Order order = new Order(myorder.getOrderDate(),myorder.getUserId(),myorder.getTotalQty(),myorder.getTotalCost(),myorder.getStatus());
//		Order ordersaved = orderDAO.save(order);//Primary key gets generated
		myorder = orderDAO.save(myorder); // Persistent Object with generated Primary Key
		int orderId = myorder.getOrderId(); 
		//Insert Order Item
		
		List<OrderItem> itemList =orderInfo.getItemList();
		for(OrderItem orderItem: itemList) 
		{
		orderItem.setOrderId(orderId);
		orderItemDAO.save(orderItem);
		}
		orderInfo.setOrder(myorder);
		orderInfo.setItemList(itemList);

		// Update the local inventory
		for(OrderItem orderItem:itemList) {
			/*
			 * From DeSearialised OrderItemInfo object, get bookId 
			 * and for respective bookId get inventory count of that book
			 * */
			int bookId = orderItem.getBookId();
			BookInventory bookInventory = bookInventoryDAO.findById(bookId).get();
			bookInventory.setBookAvailable(bookInventory.getBookAvailable()-orderItem.getQty());
			bookInventoryDAO.save(bookInventory);

			//Update Remote Inventory
			RestTemplate bookSearchRest = new RestTemplate();
			String endPoint = "http://localhost:7000/updateBookInventory";
			bookSearchRest.put(endPoint, bookInventory);
		}
		return orderInfo;

	}
	public void updateBookInventory(BookInventory bookInventoryInfo ) {
		System.out.println("BookSerachMS serviceImpl methd called");

		BookInventory bookInventory = new BookInventory();
		bookInventory.setBookAvailable(bookInventoryInfo.getBookAvailable());
		bookInventory.setBookId(bookInventoryInfo.getBookId());
		bookInventoryDAO.save(bookInventory);
		
	}

}
